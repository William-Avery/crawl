syntax = "proto3";

package crawl.v1;

// The Brain query service — exposed over UDS + gRPC-Web.
service BrainService {
    // Health check.
    rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);

    // Task operations.
    rpc SubmitTask(SubmitTaskRequest) returns (SubmitTaskResponse);
    rpc GetTask(GetTaskRequest) returns (GetTaskResponse);
    rpc ListTasks(ListTasksRequest) returns (ListTasksResponse);

    // Cell (plugin) operations.
    rpc ListCells(ListCellsRequest) returns (ListCellsResponse);

    // Memory operations.
    rpc SearchMemory(SearchMemoryRequest) returns (SearchMemoryResponse);
    rpc StoreMemory(StoreMemoryRequest) returns (StoreMemoryResponse);

    // Journal operations.
    rpc GetJournalEvents(GetJournalEventsRequest) returns (GetJournalEventsResponse);

    // Metrics.
    rpc GetMetrics(GetMetricsRequest) returns (GetMetricsResponse);

    // Research.
    rpc Research(ResearchRequest) returns (ResearchResponse);

    // Conversational query — synthesizes answer from all subsystems.
    rpc Ask(AskRequest) returns (AskResponse);

    // Comprehensive brain status dashboard.
    rpc GetBrainStatus(GetBrainStatusRequest) returns (GetBrainStatusResponse);

    // Read the soul file.
    rpc GetSoul(GetSoulRequest) returns (GetSoulResponse);

    // Query wisdom entries.
    rpc GetWisdom(GetWisdomRequest) returns (GetWisdomResponse);

    // Query discovered entities.
    rpc GetEntities(GetEntitiesRequest) returns (GetEntitiesResponse);

    // Query the investigation scoreboard.
    rpc GetScoreboard(GetScoreboardRequest) returns (GetScoreboardResponse);
}

// ── Health ──────────────────────────────────────────────────────────

message HealthCheckRequest {}

message HealthCheckResponse {
    string version = 1;
    string status = 2;
    uint64 uptime_secs = 3;
    uint32 loaded_cells = 4;
    uint64 total_tasks_completed = 5;
    uint64 ollama_queries = 6;
    uint64 ollama_tokens = 7;
}

// ── Tasks ───────────────────────────────────────────────────────────

message SubmitTaskRequest {
    string verb = 1;          // IDENTIFY, MONITOR, etc.
    string cell_id = 2;       // Target Cell.
    string description = 3;
    string target = 4;
    string params_json = 5;   // JSON-encoded parameters.
    string priority = 6;      // high, normal, low.
    Budget budget = 7;
}

message SubmitTaskResponse {
    string task_id = 1;
}

message GetTaskRequest {
    string task_id = 1;
}

message GetTaskResponse {
    TaskInfo task = 1;
}

message ListTasksRequest {
    string status_filter = 1; // pending, running, completed, failed.
    uint32 limit = 2;
}

message ListTasksResponse {
    repeated TaskInfo tasks = 1;
}

message TaskInfo {
    string id = 1;
    string verb = 2;
    string cell_id = 3;
    string description = 4;
    string target = 5;
    string status = 6;
    string created_at = 7;
    string completed_at = 8;
    string result_json = 9;
}

message Budget {
    uint64 time_budget_ms = 1;
    uint32 max_tool_calls = 2;
    uint64 max_bytes_read = 3;
    uint64 max_bytes_written = 4;
    uint32 max_network_calls = 5;
    uint32 max_llm_calls = 6;
    uint32 max_tokens_per_call = 7;
    string risk_tier = 8;
}

// ── Cells ───────────────────────────────────────────────────────────

message ListCellsRequest {}

message ListCellsResponse {
    repeated CellInfo cells = 1;
}

message CellInfo {
    string cell_id = 1;
    string name = 2;
    string version = 3;
    repeated string capabilities = 4;
    repeated string supported_verbs = 5;
}

// ── Memory ──────────────────────────────────────────────────────────

message SearchMemoryRequest {
    string query = 1;
    uint32 top_k = 2;
}

message SearchMemoryResponse {
    repeated MemoryEntry entries = 1;
}

message StoreMemoryRequest {
    string content = 1;
    string metadata_json = 2;
}

message StoreMemoryResponse {
    string id = 1;
}

message MemoryEntry {
    string id = 1;
    string content = 2;
    double similarity = 3;
    string metadata_json = 4;
    string created_at = 5;
}

// ── Journal ─────────────────────────────────────────────────────────

message GetJournalEventsRequest {
    uint32 limit = 1;
    string kind_filter = 2;
}

message GetJournalEventsResponse {
    repeated JournalEvent events = 1;
}

message JournalEvent {
    string id = 1;
    string timestamp = 2;
    string kind = 3;
    string task_id = 4;
    string cell_id = 5;
    string payload_json = 6;
}

// ── Metrics ─────────────────────────────────────────────────────────

message GetMetricsRequest {}

message GetMetricsResponse {
    double cpu_load_1m = 1;
    double cpu_load_5m = 2;
    double cpu_load_15m = 3;
    uint64 mem_total_kb = 4;
    uint64 mem_available_kb = 5;
    double mem_used_percent = 6;
    double uptime_secs = 7;
}

// ── Research ────────────────────────────────────────────────────────

message ResearchRequest {
    string query = 1;
    uint32 max_tier = 2; // 1-5.
}

message ResearchResponse {
    uint32 tier_used = 1;
    string answer = 2;
    double confidence = 3;
    repeated string sources = 4;
    bool tainted = 5;
}

// ── Ask (Conversational) ──────────────────────────────────────────

message ChatMessage {
    string role = 1;    // "user" or "assistant"
    string content = 2;
}

message AskRequest {
    string question = 1;
    uint32 max_context_items = 2; // Per-source cap (default 10).
    repeated ChatMessage history = 3; // Prior conversation turns.
}

message AskResponse {
    string answer = 1;
    repeated string sources_used = 2;
    uint64 tokens_used = 3;
}

// ── Brain Status ──────────────────────────────────────────────────

message GetBrainStatusRequest {}

message GetBrainStatusResponse {
    string version = 1;
    uint64 uptime_secs = 2;
    string maturity_level = 3;
    uint32 tasks_pending = 4;
    uint32 tasks_completed = 5;
    uint32 tasks_failed = 6;
    uint64 entity_count = 7;
    uint32 wisdom_count = 8;
    uint64 memory_count = 9;
    uint64 llm_queries = 10;
    uint64 llm_tokens = 11;
    double llm_budget_spent_usd = 12;
    string llm_primary_provider = 13;
    string soul_summary = 14;
    double ewma = 15;
    uint64 think_interval_ms = 16;
    uint32 loaded_cells = 17;
}

// ── Soul ──────────────────────────────────────────────────────────

message GetSoulRequest {}

message GetSoulResponse {
    string content = 1;
}

// ── Wisdom ────────────────────────────────────────────────────────

message GetWisdomRequest {
    string kind_filter = 1; // Optional: filter by kind.
}

message GetWisdomResponse {
    repeated WisdomEntryInfo entries = 1;
    string maturity_level = 2;
    repeated string effective_verbs = 3;
}

message WisdomEntryInfo {
    string id = 1;
    string kind = 2;
    string content = 3;
    double confidence = 4;
    uint32 times_confirmed = 5;
    uint32 times_contradicted = 6;
    repeated string tags = 7;
    string created_at = 8;
}

// ── Entities ──────────────────────────────────────────────────────

message GetEntitiesRequest {
    uint32 limit = 1;
}

message GetEntitiesResponse {
    repeated EntityInfo entities = 1;
}

message EntityInfo {
    string id = 1;
    string name = 2;
    string kind = 3;
    string description = 4;
    double confidence = 5;
    string first_seen = 6;
    string last_seen = 7;
}

// ── Scoreboard ────────────────────────────────────────────────────

message GetScoreboardRequest {
    uint32 limit = 1;
}

message GetScoreboardResponse {
    repeated ScoreboardEntry entries = 1;
    double ewma = 2;
}

message ScoreboardEntry {
    string task_id = 1;
    string verb = 2;
    string target = 3;
    double novelty = 4;
    double anomaly = 5;
    double confidence = 6;
    double actionability = 7;
    double composite = 8;
    string scored_at = 9;
    double efficiency = 10;
    // Execution telemetry (populated when available).
    uint32 tool_calls_used = 11;
    uint64 bytes_read = 12;
    uint64 bytes_written = 13;
    uint32 network_calls_used = 14;
    uint32 llm_calls_used = 15;
    uint64 duration_ms = 16;
}
