<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>crawl-brain chat</title>
<style>
:root {
  --bg: #0d1117;
  --bg2: #161b22;
  --bg3: #1c2129;
  --border: #30363d;
  --fg: #c9d1d9;
  --fg2: #8b949e;
  --accent: #58a6ff;
  --green: #3fb950;
  --yellow: #d29922;
  --red: #f85149;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', 'Cascadia Code', monospace;
  font-size: 13px;
  background: var(--bg);
  color: var(--fg);
  line-height: 1.6;
  height: 100vh;
  display: flex;
  flex-direction: column;
}
.header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.header h1 { font-size: 16px; font-weight: 600; color: var(--accent); }
.header .meta { color: var(--fg2); font-size: 12px; }
.header .meta a { color: var(--accent); text-decoration: none; opacity: 0.8; }
.header .meta a:hover { opacity: 1; }
.header .nav-right { margin-left: auto; display: flex; gap: 16px; }

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.msg {
  max-width: 80%;
  padding: 10px 14px;
  border-radius: 10px;
  word-wrap: break-word;
  white-space: pre-wrap;
}
.msg-user {
  align-self: flex-end;
  background: var(--bg2);
  border: 1px solid var(--border);
}
.msg-brain {
  align-self: flex-start;
  background: #0d2236;
  border: 1px solid #1a3a5c;
}
.msg-meta {
  font-size: 11px;
  color: var(--fg2);
  margin-top: 4px;
}

.tool-call {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 8px 10px;
  margin: 8px 0;
  font-size: 12px;
}
.tool-call .tool-kind {
  color: var(--yellow);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
}
.tool-call .tool-input {
  color: var(--accent);
  margin: 2px 0;
}
.tool-call .tool-output {
  color: var(--fg2);
  max-height: 150px;
  overflow-y: auto;
  white-space: pre-wrap;
}
.tool-call .tool-error {
  color: var(--red);
}

.thinking {
  align-self: flex-start;
  color: var(--fg2);
  font-style: italic;
  padding: 8px 14px;
}

.input-bar {
  display: flex;
  gap: 8px;
  padding: 12px 20px;
  border-top: 1px solid var(--border);
  background: var(--bg2);
  flex-shrink: 0;
}
.input-bar textarea {
  flex: 1;
  background: var(--bg);
  color: var(--fg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 8px 12px;
  font-family: inherit;
  font-size: 13px;
  line-height: 1.5;
  resize: none;
  min-height: 40px;
  max-height: 120px;
  outline: none;
}
.input-bar textarea:focus { border-color: var(--accent); }
.input-bar button {
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  font-family: inherit;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;
}
.input-bar button:hover { opacity: 0.9; }
.input-bar button:disabled { opacity: 0.4; cursor: not-allowed; }
.input-bar .btn-clear {
  background: transparent;
  color: var(--fg2);
  border: 1px solid var(--border);
}
.input-bar .btn-clear:hover { color: var(--fg); border-color: var(--fg2); }
</style>
</head>
<body>
<div class="header">
  <h1>crawl-brain</h1>
  <span class="meta"><a href="/">&larr; Dashboard</a></span>
  <div class="nav-right">
    <span class="meta"><a href="/tasks">Tasks</a></span>
  </div>
</div>

<div class="chat-messages" id="messages"></div>

<div class="input-bar">
  <textarea id="input" placeholder="Ask the brain..." rows="1"></textarea>
  <button id="send-btn" onclick="sendMessage()">Send</button>
  <button class="btn-clear" onclick="clearChat()">Clear</button>
</div>

<script>
let history = [];
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('send-btn');

// Auto-resize textarea.
inputEl.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Enter sends, Shift+Enter newline.
inputEl.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function appendMessage(role, content, meta, toolCalls) {
  const div = document.createElement('div');
  div.className = 'msg ' + (role === 'user' ? 'msg-user' : 'msg-brain');
  div.textContent = content;

  if (toolCalls && toolCalls.length > 0) {
    for (const tc of toolCalls) {
      const tcDiv = document.createElement('div');
      tcDiv.className = 'tool-call';
      const outputClass = tc.success ? 'tool-output' : 'tool-error';
      tcDiv.innerHTML =
        '<div class="tool-kind">' + escapeHtml(tc.kind) + '</div>' +
        '<div class="tool-input">' + escapeHtml(tc.input) + '</div>' +
        '<div class="' + outputClass + '">' + escapeHtml(tc.output) + '</div>';
      div.appendChild(tcDiv);
    }
  }

  if (meta) {
    const metaDiv = document.createElement('div');
    metaDiv.className = 'msg-meta';
    metaDiv.textContent = meta;
    div.appendChild(metaDiv);
  }

  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function showThinking() {
  const div = document.createElement('div');
  div.className = 'thinking';
  div.id = 'thinking';
  div.textContent = 'thinking...';
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function removeThinking() {
  const el = document.getElementById('thinking');
  if (el) el.remove();
}

async function sendMessage() {
  const msg = inputEl.value.trim();
  if (!msg) return;

  inputEl.value = '';
  inputEl.style.height = 'auto';
  sendBtn.disabled = true;

  appendMessage('user', msg);
  showThinking();

  try {
    const resp = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg, history: history }),
    });

    removeThinking();
    const data = await resp.json();

    if (data.error) {
      appendMessage('brain', 'Error: ' + data.error);
    } else {
      const parts = [];
      if (data.sources && data.sources.length) parts.push(data.sources.join(', '));
      if (data.tokens) parts.push(data.tokens + ' tok');
      if (data.tool_calls && data.tool_calls.length) parts.push(data.tool_calls.length + ' tool call(s)');
      const meta = parts.length ? parts.join(' | ') : '';

      appendMessage('brain', data.answer, meta, data.tool_calls);

      // Update history.
      history.push({ role: 'user', content: msg });
      history.push({ role: 'assistant', content: data.answer });

      // Cap history at 20 entries.
      if (history.length > 20) {
        history = history.slice(history.length - 20);
      }
    }
  } catch (e) {
    removeThinking();
    appendMessage('brain', 'Request failed: ' + e.message);
  }

  sendBtn.disabled = false;
  inputEl.focus();
}

function clearChat() {
  history = [];
  messagesEl.innerHTML = '';
  inputEl.focus();
}

inputEl.focus();
</script>
</body>
</html>
